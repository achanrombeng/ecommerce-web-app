{% extends "base-admin.html" %}

{% block title %}Edit Profil - LinkedCommerce{% endblock %}

{% block page_title %}Edit Profil{% endblock %}

{% block page_icon %}user-edit{% endblock %}

{% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <a href="{{ url_for('admin_users') }}" class="text-sm font-medium text-gray-500 hover:text-linkedin-blue">User</a>
  </div>
</li>
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Edit Profil</span>
  </div>
</li>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <form id="updateUser" action="{{ url_for('admin_update_user', user_id=user.id)}}" method="POST" enctype="multipart/form-data">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-1">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-6">Foto Profil</h3>
          
          <div class="flex flex-col items-center space-y-4">
            <div class="relative">
              <img 
                id="profilePreview" 
                src="{{ user.profile_picture or 'https://ui-avatars.com/api/?name=' + (user.first_name|urlencode) + '&background=0077b5&color=fff&size=200' }}" 
                alt="Profile" 
                class="w-40 h-40 rounded-full object-cover border-4 border-gray-100 shadow-lg"
              >
              <button 
                type="button" 
                onclick="document.getElementById('profilePicture').click()"
                class="absolute bottom-2 right-2 bg-linkedin-blue text-white p-3 rounded-full hover:bg-linkedin-dark transition shadow-lg"
              >
                <i class="fas fa-camera"></i>
              </button>
            </div>
            
            <input type="file" id="profilePicture" name="profile_picture" accept="image/*" class="hidden" onchange="previewImage(event)">
            
            <div class="text-center">
              <p class="text-sm text-gray-600">Format: JPG, PNG, GIF</p>
              <p class="text-xs text-gray-500">Maksimal: 2MB</p>
            </div>
          </div>

          <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Role:</span>
              <select name="role" class="px-2 py-1 rounded border text-xs bg-linkedin-blue text-white focus:outline-none">
                <option value="USER" {% if user.role == "USER" %}selected{% endif %}>User</option>
                <option value="ADMIN" {% if user.role == "ADMIN" %}selected{% endif %}>Admin</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2 space-y-6">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-6">Informasi Pribadi</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Depan <span class="text-red-500">*</span></label>
              <input type="text" name="first_name" value="{{ user.first_name or '' }}" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-linkedin-blue outline-none">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nama Belakang</label>
              <input type="text" name="last_name" value="{{ user.last_name or '' }}" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-linkedin-blue outline-none">
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input type="email" value="{{ user.email }}" class="w-full px-4 py-2 bg-gray-100 border rounded-lg cursor-not-allowed" disabled>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Kelamin</label>
              <select name="gender" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-linkedin-blue outline-none">
                <option value="">Pilih...</option>
                <option value="MALE" {% if user.gender == 'MALE' %}selected{% endif %}>Laki-laki</option>
                <option value="FEMALE" {% if user.gender == 'FEMALE' %}selected{% endif %}>Perempuan</option>
                <option value="OTHER" {% if user.gender == 'OTHER' %}selected{% endif %}>Lainnya</option>
              </select>
            </div>
          </div>
          
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
            <textarea name="address" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-linkedin-blue outline-none">{{ user.address or '' }}</textarea>
          </div>
        </div>

        <div class="flex justify-end space-x-3">
          <a href="{{ url_for('admin_users') }}" class="px-6 py-2 border rounded-lg hover:bg-gray-50 transition">Batal</a>
          <button type="submit" class="px-6 py-2 bg-linkedin-blue text-white rounded-lg hover:bg-linkedin-dark transition shadow-md">
            <i class="fas fa-save mr-2"></i>Simpan Perubahan
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// Preview Foto
function previewImage(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('profilePreview').src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
}

// Submit Ajax
document.getElementById('updateUser').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const confirm = await Swal.fire({
    title: 'Simpan Perubahan?',
    text: "Data user akan diperbarui.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#0077b5',
    confirmButtonText: 'Ya, Simpan!'
  });

  if (!confirm.isConfirmed) return;

  Swal.fire({ title: 'Menyimpan...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

  try {
    const formData = new FormData(this);
    const response = await fetch(this.action, {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    Swal.close();

    if (data.success) {
      await Swal.fire({ icon: 'success', title: 'Berhasil!', text: data.message });
      window.location.href = "{{ url_for('admin_users') }}";
    } else {
      Swal.fire({ icon: 'error', title: 'Gagal', text: data.message });
    }
  } catch (error) {
    Swal.fire({ icon: 'error', title: 'Error', text: 'Terjadi kesalahan jaringan.' });
  }
});
</script>
{% endblock %}