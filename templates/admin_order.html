{% extends "base-admin.html" %} 
{% block title %}Kelola Pesanan - LinkedCommerce{% endblock %} 
{% block page_title %}Kelola Pesanan{% endblock %}
{% block page_icon %}shopping-bag{% endblock %} 
{% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Pesanan</span>
  </div>
</li>
{% endblock %} 

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<style>
  /* 1. Paksa Container Utama */
  .overflow-x-auto.w-full {
    display: block !important;
    width: 100% !important;
    overflow-x: auto !important;
  }

  /* 2. Paksa Tabel dan Wrapper Datatables */
  #ordersTable,
  .dataTables_wrapper,
  .dataTables_scrollHeadInner,
  .dataTables_scrollBody,
  table.dataTable {
    width: 100% !important;
    min-width: 100% !important;
    margin: 0 !important;
  }

  /* 3. Pengaturan Rata Kiri Semua Kolom */
  #ordersTable th, 
  #ordersTable td {
    text-align: left !important;
    vertical-align: middle !important;
    padding: 12px 16px !important;
  }

  #ordersTable td {
    white-space: nowrap;
  }

  /* Izinkan Kolom Pelanggan untuk Wrap */
  #ordersTable td:nth-child(3) {
    white-space: normal !important;
    min-width: 200px;
  }

  .dataTables_wrapper .grid {
    margin: 0 !important;
    width: 100% !important;
  }
</style>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row justify-start items-start md:items-center gap-4" data-aos="fade-up">
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Daftar Pesanan</h2>
      <p class="text-sm text-gray-600 mt-1">Kelola semua pesanan pelanggan</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6" data-aos="fade-up" data-aos-delay="100">
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-linkedin-blue">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Pesanan</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalOrders">{{ orders|length }}</h3>
        </div>
        <div class="bg-linkedin-background p-3 rounded-full">
          <i class="fas fa-shopping-bag text-linkedin-blue text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Pending</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="pendingOrders">{{ pending }}</h3>
        </div>
        <div class="bg-yellow-50 p-3 rounded-full">
          <i class="fas fa-clock text-yellow-500 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Approved</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="approvedOrders">{{ approved }}</h3>
        </div>
        <div class="bg-purple-50 p-3 rounded-full">
          <i class="fas fa-cog text-purple-500 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Cancelled</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="cancelledOrders">{{ cancel }}</h3>
        </div>
        <div class="bg-red-50 p-3 rounded-full">
          <i class="fas fa-times-circle text-red-500 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow" data-aos="fade-up" data-aos-delay="200">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-list"></i> Daftar Pesanan
        </h2>
        <div class="gap-4 flex">
          <button type="button" onclick="reloadTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fa-solid fa-rotate-right mr-1"></i>Refresh
          </button>
        </div>
      </div>

      <div class="overflow-x-auto w-full">
        <table id="ordersTable" class="w-full" style="width: 100% !important">
          <thead class="bg-gray-100 border-b border-gray-300">
            <tr class="bg-gray-50">
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3">
                <input type="text" id="filterCustomer" placeholder="Filter Pelanggan" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <input type="date" id="filterDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <input type="number" id="filterAmount" placeholder="Max Amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Status</option>
                  <option value="pending">Pending</option>
                  <option value="approve">Approved</option>
                  <option value="cancel">Cancelled</option>
                </select>
              </th>
              <th class="px-4 py-3"></th>
            </tr>
            <tr>
              <th class="text-sm font-semibold text-gray-700">No</th>
              <th class="text-sm font-semibold text-gray-700">ID Pesanan</th>
              <th class="text-sm font-semibold text-gray-700">Pelanggan</th>
              <th class="text-sm font-semibold text-gray-700">Tanggal</th>
              <th class="text-sm font-semibold text-gray-700">Total</th>
              <th class="text-sm font-semibold text-gray-700">Status</th>
              <th class="text-sm font-semibold text-gray-700">Aksi</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Variabel Global
  var orderTable;
  const canUpdate = "{{ can_update|default(true)|tojson }}";

  $(document).ready(function() {
    // Inisialisasi DataTable
    orderTable = $('#ordersTable').DataTable({
      processing: true,
      serverSide: false,
      autoWidth: false,
      searching: false,
      ordering: true,
      pageLength: 10,
      order: [[1, 'desc']], // Sort by ID Pesanan
      dom: 'rtip',
      ajax: {
        url: "{{ url_for('admin_orders') }}",
        type: "POST",
        data: function(d) {
          return {
            customer: $('#filterCustomer').val(),
            date: $('#filterDate').val(),
            maxAmount: $('#filterAmount').val(),
            status: $('#filterStatus').val()
          };
        }
      },
      columns: [
        {
          data: null,
          className: "text-left",
          render: (data, type, row, meta) => meta.row + 1,
        },
        {
          data: "id",
          className: "text-left",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm font-medium text-linkedin-blue">#${data}</div>
              <div class="text-sm text-gray-500">${row.total_items} items</div>
            </div>`;
          }
        },
        {
         data: "customer_name",
  className: "text-left",
  render: function(data, type, row) {
    // Gunakan row.customer_avatar (Base64 dari Flask) 
    // Jika kosong, gunakan UI-Avatars
    const avatarUrl = row.customer_avatar; 
    
    return `<div class="flex items-center justify-start">
      <div class="h-10 w-10 flex-shrink-0">
        <img class="h-10 w-10 rounded-full object-cover border border-gray-200"
             src="${avatarUrl}"
             onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data)}&background=0077b5&color=fff'" />
      </div>
      <div class="ml-4">
        <div class="text-sm font-medium text-gray-900">${data}</div>
        <div class="text-sm text-gray-500">${row.customer_email}</div>
      </div>
    </div>`;
  }
        },
        {
          data: "created_at",
          className: "text-left",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm text-gray-900">${row.date}</div>
              <div class="text-xs text-gray-500">${row.time} WIB</div>
            </div>`;
          }
        },
        {
          data: "amount",
          className: "text-left",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm font-medium text-gray-900">Rp ${data}</div>
              <div class="text-xs text-gray-500">${row.payment_method}</div>
            </div>`;
          }
        },
        {
          data: "status",
          className: "text-left",
          render: function(data, type, row) {
            const statusConfig = {
              'Pending': { color: 'bg-yellow-100 text-yellow-800', icon: 'fa-clock' },
              'Approve': { color: 'bg-purple-100 text-purple-800', icon: 'fa-cog' },
              'Cancel': { color: 'bg-red-100 text-red-800', icon: 'fa-times' }
            };
            const config = statusConfig[data] || { color: 'bg-blue-100 text-blue-800', icon: 'fa-truck' };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}">
              <i class="fas ${config.icon} mr-1"></i>${data}
            </span>`;
          }
        },
        {
  data: null,
  className: "text-left",
  orderable: false,
  render: function(data, type, row) {
    console.log('Row data:', row); // Cek di console
    return `
      <div class="flex space-x-2 justify-start">
        <button onclick="orderDetail(${row.id}, ${row.user_id})" title="Detail Order"
                class="p-2 text-linkedin-blue hover:bg-blue-50 rounded-lg inline-block">
          <i class="fas fa-eye"></i>
        </button>
      </div>`;
}
}
      ],
      drawCallback: function() {
        this.api().columns.adjust();
      }
    });

    // Event Filter
    let filterTimeout;
    $('#filterCustomer, #filterAmount').on('input', function() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(() => { orderTable.ajax.reload(); }, 500);
    });

    $('#filterDate, #filterStatus').on('change', function() {
      orderTable.ajax.reload();
    });
  });

  // Functions
  function reloadTable() {
    if (orderTable) {
      orderTable.ajax.reload(null, false);
      Swal.fire({
        icon: 'success',
        title: 'Data di-refresh',
        showConfirmButton: false,
        timer: 1000,
        toast: true,
        position: 'top-end'
      });
    }
  }

  function orderDetail(orderId, userId) {
    console.log('Order ID:', orderId, 'User ID:', userId);
    if (orderId && userId) {
        window.location.href = `/admin/orders-detail/${orderId}/${userId}`;
    } else {
        alert("Data tidak lengkap. Order ID: " + orderId + ", User ID: " + userId);
    }
}
</script>

<style>
  #ordersTable_wrapper .dataTables_paginate .paginate_button.current {
    background: #0a66c2 !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
  }
</style>
{% endblock %}