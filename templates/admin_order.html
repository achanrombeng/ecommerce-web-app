{% extends "base-admin.html" %} 
{% block title %}Kelola Pesanan - LinkedCommerce{% endblock %} 
{% block page_title %}Kelola Pesanan{% endblock %}
{% block page_icon %}shopping-bag{% endblock %} 
{% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Pesanan</span>
  </div>
</li>
{% endblock %} 

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<div class="space-y-6">
  <!-- Header Actions -->
  <div class="flex flex-col md:flex-row justify-start items-start md:items-center gap-4" data-aos="fade-up">
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Daftar Pesanan</h2>
      <p class="text-sm text-gray-600 mt-1">Kelola semua pesanan pelanggan</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6" data-aos="fade-up" data-aos-delay="100">
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-linkedin-blue">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Pesanan</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalOrders">
            {{ orders|length }}
          </h3>
        </div>
        <div class="bg-linkedin-background p-3 rounded-full">
          <i class="fas fa-shopping-bag text-linkedin-blue text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Pending</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="pendingOrders">{{ pending }}</h3>
        </div>
        <div class="bg-yellow-50 p-3 rounded-full">
          <i class="fas fa-clock text-yellow-500 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Approved</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="approvedOrders">{{ approved }}</h3>
        </div>
        <div class="bg-purple-50 p-3 rounded-full">
          <i class="fas fa-cog text-purple-500 text-xl"></i>
        </div>
      </div>
    </div>

    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Cancelled</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="cancelledOrders">{{ cancel }}</h3>
        </div>
        <div class="bg-red-50 p-3 rounded-full">
          <i class="fas fa-times-circle text-red-500 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Orders Table -->
  <div class="bg-white rounded-lg shadow" data-aos="fade-up" data-aos-delay="200">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-list"></i> Daftar Pesanan
        </h2>
        <div class="gap-4 flex">
          <button onclick="reloadTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fa-solid fa-rotate-right mr-1"></i>Refresh
          </button>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table id="ordersTable" class="w-full">
          <thead class="bg-gray-100 border-b border-gray-300">
            <!-- Filter Row -->
            <tr class="bg-gray-50">
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3">
                <input type="text" id="filterCustomer" placeholder="Filter Pelanggan" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <input type="date" id="filterDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <input type="number" id="filterAmount" placeholder="Max Amount" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Status</option>
                  <option value="pending">Pending</option>
                  <option value="approve">Approved</option>
                  <option value="cancel">Cancelled</option>
                </select>
              </th>
              <th class="px-4 py-3"></th>
            </tr>

            <!-- Header Row -->
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">No</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID Pesanan</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Pelanggan</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Tanggal</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Total</th>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Status</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Aksi</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <!-- Data will be populated by DataTables -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let orderTable;

  const canUpdate = {{ can_update|default(true)|tojson }};

  // Update stats dari server
  $(document).ready(function() {
    $('#totalOrders').text({{ orders|length }});
    $('#pendingOrders').text({{ pending }});
    $('#approvedOrders').text({{ approved }});
    $('#cancelledOrders').text({{ cancel }});
  });

  // Order Table
  $(function() {
    orderTable = $('#ordersTable').DataTable({
      processing: true,
      searching: false,
      ordering: true,
      pageLength: 10,
      order: [[0, 'desc']], // Sort by ID descending
      language: {
        processing: "Memuat data...",
        emptyTable: "Tidak ada data pesanan",
        zeroRecords: "Tidak ada data yang sesuai filter"
      },
      createdRow: function(row, data, dataIndex) {
        $(row).css("background-color", dataIndex % 2 === 0 ? "#f9fafb" : "white");
      },
      ajax: {
        url: "{{ url_for('admin_orders') }}",
        type: "POST",
        data: function(d) {
          const filters = {
            customer: $('#filterCustomer').val(),
            date: $('#filterDate').val(),
            maxAmount: $('#filterAmount').val(),
            status: $('#filterStatus').val()
          };
          console.log('Sending filters:', filters);
          return filters;
        },
        dataSrc: function(json) {
          console.log('Received data:', json);
          return json.data;
        },
        error: function(xhr, error, code) {
          console.error('Ajax Error:', error);
          console.error('Status:', xhr.status);
          console.error('Response:', xhr.responseText);

          Swal.fire({
            icon: 'error',
            title: 'Error Memuat Data',
            text: 'Status: ' + xhr.status + ' - ' + error,
            footer: 'Periksa console untuk detail'
          });
        }
      },
      columns: [
        {
          data: null,
          render: (data, type, row, meta) => meta.row + meta.settings._iDisplayStart + 1,
        },
        {
          data: "id",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm font-medium text-linkedin-blue">#${data}</div>
              <div class="text-sm text-gray-500">${row.total_items} items</div>
            </div>`;
          }
        },
        {
          data: "customer_name",
          render: function(data, type, row) {
            return `<div class="flex items-center">
              <div class="h-8 w-8 flex-shrink-0">
                <img class="h-8 w-8 rounded-full" src="${row.customer_avatar}" alt="" />
              </div>
              <div class="ml-3">
                <div class="text-sm font-medium text-gray-900">${data}</div>
                <div class="text-sm text-gray-500">${row.customer_email}</div>
              </div>
            </div>`;
          }
        },
        {
          data: "created_at",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm text-gray-900">${row.date}</div>
              <div class="text-xs text-gray-500">${row.time} WIB</div>
            </div>`;
          }
        },
        {
          data: "amount",
          render: function(data, type, row) {
            return `<div>
              <div class="text-sm font-medium text-gray-900">Rp ${data}</div>
              <div class="text-xs text-gray-500">${row.payment_method}</div>
            </div>`;
          }
        },
        {
          data: "status",
          render: function(data, type, row) {
            const statusConfig = {
              'Pending': { color: 'bg-yellow-100 text-yellow-800', icon: 'fa-clock' },
              'Approve': { color: 'bg-purple-100 text-purple-800', icon: 'fa-cog' },
              'Cancel': { color: 'bg-red-100 text-red-800', icon: 'fa-times' }
            };
            const config = statusConfig[data] || { color: 'bg-blue-100 text-blue-800', icon: 'fa-truck' };
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${config.color}">
              <i class="fas ${config.icon} mr-1"></i>${data}
            </span>`;
          }
        },
        {
          data: null,
          render: function(data, type, row) {
            return `<div class="flex space-x-2 justify-center">
              <button class="text-linkedin-blue hover:text-linkedin-dark" onclick="viewOrder(${row.id})" title="Detail">
                <i class="fas fa-eye"></i>
              </button>
              ${canUpdate ? `<button class="text-green-600 hover:text-green-900" onclick="editOrder(${row.id})" title="Edit">
                <i class="fas fa-edit"></i>
              </button>` : ''}
              <button class="text-purple-600 hover:text-purple-900" onclick="trackOrder(${row.id})" title="Lacak">
                <i class="fas fa-shipping-fast"></i>
              </button>
            </div>`;
          }
        }
      ]
    });

    // Filter dengan debounce untuk input text dan number
    let filterTimeout;
    $('#filterCustomer, #filterAmount').on('input', function() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(function() {
        console.log('Reloading table with filters...');
        orderTable.ajax.reload();
      }, 500);
    });

    // Filter langsung untuk date dan select
    $('#filterDate, #filterStatus').on('change', function() {
      console.log('Filter changed, reloading...');
      orderTable.ajax.reload();
    });
  });

  // Function untuk view order
  function viewOrder(id) {
    window.location.href = `/admin/orders/${id}`;
  }

  // Function untuk edit order
  function editOrder(id) {
    if (!canUpdate) {
      Swal.fire('Akses Ditolak', 'Anda tidak memiliki izin untuk mengedit pesanan', 'error');
      return;
    }
    window.location.href = `/admin/orders/${id}/edit`;
  }

  // Function untuk track order
  function trackOrder(id) {
    window.location.href = `/admin/orders/${id}/track`;
  }

  // Function untuk reload table
  function reloadTable() {
    orderTable.ajax.reload();
    Swal.fire({
      icon: 'success',
      title: 'Data berhasil di-refresh',
      showConfirmButton: false,
      timer: 1500
    });
  }
</script>

<style>
  #ordersTable_wrapper .dataTables_length,
  #ordersTable_wrapper .dataTables_filter,
  #ordersTable_wrapper .dataTables_info,
  #ordersTable_wrapper .dataTables_paginate {
    padding: 1rem;
  }

  #ordersTable_wrapper .dataTables_filter input {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    margin-left: 0.5rem;
  }

  #ordersTable_wrapper .dataTables_length select {
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    margin: 0 0.5rem;
  }

  .dataTables_paginate .paginate_button {
    padding: 0.25rem 0.75rem;
    margin: 0 0.25rem;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
  }

  .dataTables_paginate .paginate_button.current {
    background-color: #0a66c2;
    color: white;
    border-color: #0a66c2;
  }

  .dataTables_paginate .paginate_button:hover:not(.current) {
    background-color: #f3f4f6;
  }
</style>
{% endblock %}