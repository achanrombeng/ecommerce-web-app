{% extends "base-admin.html" %} 
{% block title %}Kelola Pengguna - LinkedCommerce{% endblock %} 
{% block page_title %}Kelola Pengguna{% endblock %}
{% block page_icon %}users{% endblock %} 
{% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Pengguna</span>
  </div>
</li>
{% endblock %} 

{% block content %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />

<style>
  /* 1. Paksa Container Utama */
  .overflow-x-auto.w-full {
    display: block !important;
    width: 100% !important;
    overflow-x: auto !important;
  }

  /* 2. Paksa Tabel dan Wrapper Datatables */
  #usersTable,
  .dataTables_wrapper,
  .dataTables_scrollHeadInner,
  .dataTables_scrollBody,
  table.dataTable {
    width: 100% !important;
    min-width: 100% !important;
    margin: 0 !important;
  }

  /* 3. Pengaturan Rata Kiri Semua Kolom */
  #usersTable th, 
  #usersTable td {
    text-align: left !important;
    vertical-align: middle !important;
    padding: 12px 16px !important;
  }

  #usersTable td {
    white-space: nowrap;
  }

  /* Izinkan Kolom Nama untuk Wrap */
  #usersTable td:nth-child(2) {
    white-space: normal !important;
    min-width: 250px;
  }

  .dataTables_wrapper .grid {
    margin: 0 !important;
    width: 100% !important;
  }
</style>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row justify-start items-start md:items-center gap-4" data-aos="fade-up">
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Manajemen Pengguna</h2>
      <p class="text-sm text-gray-600 mt-1">Kelola semua pengguna terdaftar di sistem</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6" data-aos="fade-up" data-aos-delay="100">
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-linkedin-blue">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Pengguna</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalUsers">{{ users|length }}</h3>
        </div>
        <div class="bg-linkedin-background p-3 rounded-full">
          <i class="fas fa-users text-linkedin-blue text-xl"></i>
        </div>
      </div>
    </div>
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">User</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="activeUsers">{{ total_users }}</h3>
        </div>
        <div class="bg-green-50 p-3 rounded-full">
          <i class="fas fa-user-check text-green-500 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Admin</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="adminUsers">{{ total_admins }}</h3>
        </div>
        <div class="bg-purple-50 p-3 rounded-full">
          <i class="fas fa-shield-alt text-purple-500 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow" data-aos="fade-up" data-aos-delay="200">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-list"></i> Daftar Pengguna
        </h2>
        <div class="gap-4 flex">
          <a href="{{ url_for('admin_add_user') }}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition duration-200">
            <i class="fas fa-user-plus mr-2"></i>Tambah Pengguna
          </a>
          <button type="button" onclick="reloadTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fa-solid fa-rotate-right mr-1"></i>Refresh
          </button>
        </div>
      </div>

      <div class="overflow-x-auto w-full">
        <table id="usersTable" class="w-full" style="width: 100% !important">
          <thead class="bg-gray-100 border-b border-gray-300">
            <tr class="bg-gray-50">
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3">
                <input type="text" id="filterName" placeholder="Filter Nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <input type="text" id="filterEmail" placeholder="Filter Email" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue" />
              </th>
              <th class="px-4 py-3">
                <select id="filterRole" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Role</option>
                  <option value="admin">Admin</option>
                  <option value="user">User</option>
                </select>
              </th>
              <th class="px-4 py-3">
                <select id="filterGender" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Gender</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
              </th>
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3"></th>
            </tr>
            <tr>
              <th class="text-sm font-semibold text-gray-700">No</th>
              <th class="text-sm font-semibold text-gray-700">Nama</th>
              <th class="text-sm font-semibold text-gray-700">Email</th>
              <th class="text-sm font-semibold text-gray-700">Role</th>
              <th class="text-sm font-semibold text-gray-700">Gender</th>
              <th class="text-sm font-semibold text-gray-700">Tanggal Lahir</th>
              <th class="text-sm font-semibold text-gray-700">Aksi</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // Deklarasi Global
  var userTable;
  const canUpdate = "{{ can_update|default(true)|tojson }}";

  $(document).ready(function() {
    userTable = $('#usersTable').DataTable({
      processing: true,
      serverSide: false,
      autoWidth: false,
      searching: false,
      ordering: true,
      pageLength: 10,
      dom: 'rtip',
      ajax: {
        url: "{{ url_for('admin_users') }}",
        type: "POST",
        data: function(d) {
          return {
            name: $('#filterName').val(),
            email: $('#filterEmail').val(),
            role: $('#filterRole').val(),
            gender: $('#filterGender').val()
          };
        }
      },
      columns: [
        {
          data: null,
          className: "text-left",
          render: (data, type, row, meta) => meta.row + 1,
        },
        {
          data: "first_name",
          className: "text-left",
          render: function(data, type, row) {
            const fullName = (data + ' ' + (row.last_name || '')).trim();
            const avatarUrl = row.profile_picture
                              ? row.profile_picture
                              : `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=0077b5&color=fff`;
            return `<div class="flex items-center justify-start">
              <div class="h-10 w-10 flex-shrink-0">
                <img class="h-10 w-10 rounded-full object-cover border border-gray-200"
                     src="${avatarUrl}"
                     onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(data)}&background=0077b5&color=fff'" />
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">${fullName}</div>
              </div>
            </div>`;
          }
        },
        { data: "email", className: "text-left" },
        {
          data: "role",
          className: "text-left",
          render: function(data) {
            const roleColors = { 'admin': 'bg-red-100 text-red-800', 'user': 'bg-blue-100 text-blue-800' };
            const colorClass = roleColors[data.toLowerCase()] || 'bg-gray-100 text-gray-800';
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">
              <i class="fas fa-shield-alt mr-1"></i>${data}
            </span>`;
          }
        },
        {
          data: "gender",
          className: "text-left",
          render: function(data) {
            const genderColors = { 'male': 'bg-blue-100 text-blue-800', 'female': 'bg-pink-100 text-pink-800' };
            const colorClass = genderColors[data.toLowerCase()] || 'bg-gray-100 text-gray-800';
            return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${colorClass}">${data}</span>`;
          }
        },
        { data: "birth_date", className: "text-left" },
        {
          data: null,
          className: "text-left",
          orderable: false,
          render: function(data, type, row) {
            if (canUpdate == true || canUpdate == "true") {
              return `
              <div class="flex justify-start">
                <button class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" onclick="editUser(${row.id})" title="Edit">
                  <i class="fas fa-edit"></i>
                </button>
              </div>`;
            }
            return '<span class="text-gray-400 text-xs">No Action</span>';
          }
        }
      ],
      drawCallback: function() {
        this.api().columns.adjust();
      }
    });

    // Filter Events
    let filterTimeout;
    $('#filterName, #filterEmail').on('input', function() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(() => userTable.ajax.reload(), 500);
    });
    $('#filterRole, #filterGender').on('change', () => userTable.ajax.reload());
  });

  // Global Functions
  function reloadTable() {
    if (userTable) {
      userTable.ajax.reload(null, false);
      Swal.fire({
        icon: 'success',
        title: 'Data di-refresh',
        showConfirmButton: false,
        timer: 1000,
        toast: true,
        position: 'top-end'
      });
    }
  }

  function editUser(id) {
    window.location.href = "{{ url_for('admin_edit_user', user_id=0) }}".replace('0', id);
  }
</script>

<style>
  #usersTable_wrapper .dataTables_paginate .paginate_button.current {
    background: #0a66c2 !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
  }
</style>
{% endblock %}