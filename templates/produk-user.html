{% extends "base.html" %} 
{% block title %}Produk - LinkedCommerce{% endblock %} 
{% block content %}

<main class="bg-white rounded-lg shadow border border-gray-200 p-4 md:p-6" data-aos="fade-up">
  <div id="productsContent" class="page-content">
    
    <div class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-th-large mr-2 text-linkedin-blue"></i>
            Semua Produk
          </h3>
          <p class="text-sm text-gray-500 mt-1">Daftar produk terbaik untuk kebutuhan Anda ({{ products|length }} item)</p>
        </div>

        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <div class="relative flex-1 sm:min-w-[250px]">
            <input
              type="search"
              id="searchInput"
              placeholder="Cari produk..."
              class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:ring-1 focus:ring-linkedin-blue focus:border-linkedin-blue outline-none text-sm transition-all"
            />
            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
          </div>

          <div class="flex gap-2">
            <select
              id="categoryFilter"
              class="border border-gray-300 rounded-full px-4 py-2 text-sm flex-1 bg-white outline-none focus:ring-1 focus:ring-linkedin-blue"
            >
              <option value="">Semua Kategori</option>
              <option value="smartphone">Smartphone</option>
              <option value="laptop">Laptop</option>
              <option value="tablet">Tablet</option>
              <option value="aksesoris">Aksesoris</option>
            </select>

            <select
              id="sortFilter"
              class="border border-gray-300 rounded-full px-4 py-2 text-sm flex-1 bg-white outline-none focus:ring-1 focus:ring-linkedin-blue"
            >
              <option value="">Urutkan</option>
              <option value="price-asc">Harga Terendah</option>
              <option value="price-desc">Harga Tertinggi</option>
              <option value="name-asc">Nama A-Z</option>
              <option value="name-desc">Nama Z-A</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div
      id="productGrid"
      class="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
    >
      {% if products %} 
      {% for product in products %}
      <div
        class="product-card group bg-white rounded-xl shadow-sm overflow-hidden border border-gray-200 hover:shadow-md transition-all duration-300"
        data-name="{{ product.product_name|lower }}"
        data-category="{{ product.product_category|lower }}"
        data-price="{{ product.product_price }}"
      >
        <div class="h-44 bg-gray-100 relative flex items-center justify-center overflow-hidden">
          {% if product.product_image %}
          <img
            src="{{ product.product_image }}"
            alt="{{ product.product_name }}"
            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
          />
          {% else %}
          <div class="text-gray-300 flex flex-col items-center">
            <i class="fas fa-image text-3xl"></i>
            <p class="text-[10px] mt-1 uppercase font-bold tracking-widest">No Image</p>
          </div>
          {% endif %}

          <div class="absolute top-2 left-2 flex flex-col gap-1">
            {% if loop.index <= 4 %}
            <span class="bg-linkedin-blue text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">NEW</span>
            {% endif %}
          </div>

          {% if product.product_stock == 0 %}
          <div class="absolute inset-0 bg-white/60 flex items-center justify-center">
             <span class="bg-red-600 text-white text-[10px] font-bold px-3 py-1 rounded-full shadow-lg">STOK HABIS</span>
          </div>
          {% elif product.product_stock < 10 %}
          <span class="absolute top-2 right-2 bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">
            SISA {{ product.product_stock }}
          </span>
          {% endif %}
        </div>

        <div class="p-4">
          <p class="text-[10px] text-linkedin-blue font-bold uppercase tracking-wider mb-1">
            {{ product.product_category if product.product_category else 'UMUM' }}
          </p>

          <h4 class="font-bold text-gray-800 mb-3 line-clamp-2 h-10 leading-snug">
            {{ product.product_name }}
          </h4>

          <div class="flex flex-col gap-3">
            <span class="text-lg font-bold text-gray-900">
              Rp {{ "{:,.0f}".format(product.product_price | float).replace(',', '.') }}
            </span>

            <div class="grid grid-cols-1 gap-2">
              {% if product.product_stock > 0 %}
              <a
                href="{{ url_for('form_order_user', product_id=product.id) }}"
                class="w-full bg-linkedin-blue text-white py-2 rounded-full text-xs font-bold hover:bg-linkedin-dark transition-all text-center shadow-sm"
              >
                Pesan Sekarang
              </a>
              <button
                onclick="addToCart({{ product.id }})"
                class="w-full border border-linkedin-blue text-linkedin-blue py-2 rounded-full text-xs font-bold hover:bg-blue-50 transition-all flex items-center justify-center gap-2"
              >
                <i class="fas fa-shopping-cart text-[10px]"></i> + Keranjang
              </button>
              {% else %}
              <button
                disabled
                class="w-full bg-gray-200 text-gray-400 py-2 rounded-full text-xs font-bold cursor-not-allowed"
              >
                Stok Tidak Tersedia
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      {% endfor %} 
      {% else %}
      <div class="col-span-full text-center py-20 bg-linkedin-background rounded-xl border-2 border-dashed border-gray-200">
        <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-bold text-gray-600">Produk Belum Tersedia</h3>
        <p class="text-sm text-gray-500">Silakan kembali lagi nanti.</p>
      </div>
      {% endif %}
    </div>

    {% if products|length > 12 %}
    <div class="mt-12 text-center">
      <button
        id="loadMoreBtn"
        class="border-2 border-linkedin-blue text-linkedin-blue px-10 py-2 rounded-full font-bold text-sm hover:bg-blue-50 transition-all"
      >
        Tampilkan Lebih Banyak
      </button>
    </div>
    {% endif %}
  </div>
</main>

<script>
  // Re-use logic for Filtering and Sorting
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const sortFilter = document.getElementById("sortFilter");
  const productCards = document.querySelectorAll(".product-card");

  function filterProducts() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedCategory = categoryFilter.value.toLowerCase();

    productCards.forEach((card) => {
      const name = card.dataset.name;
      const category = card.dataset.category;
      const matchesSearch = name.includes(searchTerm);
      const matchesCategory = !selectedCategory || category === selectedCategory;
      
      card.style.display = (matchesSearch && matchesCategory) ? "block" : "none";
    });
  }

  function sortProducts() {
    const sortValue = sortFilter.value;
    const grid = document.getElementById("productGrid");
    const cards = Array.from(productCards);

    cards.sort((a, b) => {
      const priceA = parseFloat(a.dataset.price);
      const priceB = parseFloat(b.dataset.price);
      if (sortValue === "price-asc") return priceA - priceB;
      if (sortValue === "price-desc") return priceB - priceA;
      if (sortValue === "name-asc") return a.dataset.name.localeCompare(b.dataset.name);
      if (sortValue === "name-desc") return b.dataset.name.localeCompare(a.dataset.name);
      return 0;
    });

    cards.forEach(card => grid.appendChild(card));
  }

  searchInput?.addEventListener("input", filterProducts);
  categoryFilter?.addEventListener("change", filterProducts);
  sortFilter?.addEventListener("change", sortProducts);

 function addToCart(productId) {
    const event = window.event; // Menangkap global event jika tidak dikirim eksplisit
    const btn = event.currentTarget || event.target.closest('button');
    
    const originalContent = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

    fetch(`/add-to-cart/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Notifikasi Sukses
            Swal.fire({
                icon: "success",
                title: "Berhasil!",
                text: data.message,
                showConfirmButton: false,
                timer: 1500,
                iconColor: '#0a66c2',
                toast: true, // Ubah jadi toast agar tidak mengganggu flow belanja
                position: 'top-end'
            });
        } else {
            // Notifikasi Gagal (Misal: Stok Habis)
            Swal.fire({
                icon: "error",
                title: "Gagal",
                text: data.message,
                confirmButtonColor: '#0a66c2'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: "error",
            title: "Error",
            text: "Terjadi kesalahan jaringan",
            confirmButtonColor: '#0a66c2'
        });
    })
    .finally(() => {
        // Kembalikan tombol ke keadaan semula
        btn.disabled = false;
        btn.innerHTML = originalContent;
    });
}
</script>
{% endblock %}