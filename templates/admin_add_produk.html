{% extends "base-admin.html" %}

{% block title %}Tambah Produk - LinkedCommerce{% endblock %}

{% block page_title %}Tambah Produk{% endblock %}

{% block page_icon %}plus-circle{% endblock %}

{% block breadcrumb %}
<style>
.border-dashed {
  transition: all 0.3s ease;
  cursor: pointer;
}

.border-dashed:hover {
  border-color: #0a66c2;
  background-color: #f8fafc;
}

.border-dashed.border-linkedin-blue {
  border-color: #0a66c2;
  background-color: #eff6ff;
}

.border-dashed.border-red-300 {
  border-color: #fca5a5;
  background-color: #fef2f2;
}

.border-dashed.border-green-300 {
  border-color: #86efac;
  background-color: #f0fdf4;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  ring: 2px;
}

.error-message {
  animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <a href="/admin/products" class="text-sm font-medium text-gray-500 hover:text-linkedin-blue">Produk</a>
  </div>
</li>
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Tambah Produk</span>
  </div>
</li>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header Actions -->
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4" data-aos="fade-up">
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Tambah Produk Baru</h2>
      <p class="text-sm text-gray-600 mt-1">Isi formulir di bawah untuk menambahkan produk baru ke toko online Anda</p>
    </div>
    <div class="flex space-x-2">
      <a href="/admin/products" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium transition duration-200">
        <i class="fas fa-arrow-left mr-2"></i>Kembali
      </a>
    </div>
  </div>

  <!-- Form Tambah Produk -->
<div class="bg-white rounded-lg shadow p-6" data-aos="fade-up" data-aos-delay="100">
  <form id="addProductForm" method="POST" enctype="multipart/form-data">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Kolom Kiri -->
      <div class="space-y-6">
        <!-- Informasi Dasar -->
        <div>
          <h3 class="text-lg font-medium text-gray-800 mb-4">Informasi Dasar</h3>
          
          <!-- Nama Produk -->
          <div class="mb-4">
            <label for="product_name" class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
            <input
              type="text"
              id="product_name"
              name="product_name"
              placeholder="Masukkan nama produk"
              class="w-full bg-linkedin-background rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
              required
            />
          </div>
          
          <!-- Kategori -->
          <div class="mb-4">
            <label for="product_category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
            <select 
              id="product_category" 
              name="product_category"
              class="w-full bg-linkedin-background rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
              required
            >
              <option value="">Pilih Kategori</option>
              <option value="smartphone">Smartphone</option>
              <option value="laptop">Laptop</option>
              <option value="aksesoris">Aksesoris</option>
              <option value="tablet">Tablet</option>
            </select>
          </div>
          
          <!-- Deskripsi -->
          <div class="mb-4">
            <label for="product_description" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Produk</label>
            <textarea
              id="product_description"
              name="product_description"
              rows="4"
              placeholder="Masukkan deskripsi produk"
              class="w-full bg-linkedin-background rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
            ></textarea>
          </div>
        </div>
        
        <!-- Harga & Stok -->
        <div>
          <h3 class="text-lg font-medium text-gray-800 mb-4">Harga & Stok</h3>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Harga -->
            <div class="mb-4">
              <label for="product_price" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
              <input
                type="number"
                id="product_price"
                name="product_price"
                placeholder="0"
                min="0"
                class="w-full bg-linkedin-background rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
                required
              />
            </div>
            
            <!-- Stok -->
            <div class="mb-4">
              <label for="product_stock" class="block text-sm font-medium text-gray-700 mb-1">Stok</label>
              <input
                type="number"
                id="product_stock"
                name="product_stock"
                placeholder="0"
                min="0"
                class="w-full bg-linkedin-background rounded-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
                required
              />
            </div>
          </div>
          
          <!-- Status -->
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Status Produk</label>
            <div class="flex items-center space-x-4">
              <label class="inline-flex items-center">
                <input type="radio" name="product_status" value="1" class="text-linkedin-blue focus:ring-linkedin-blue" checked>
                <span class="ml-2 text-sm text-gray-700">Aktif</span>
              </label>
              <label class="inline-flex items-center">
                <input type="radio" name="product_status" value="0" class="text-linkedin-blue focus:ring-linkedin-blue">
                <span class="ml-2 text-sm text-gray-700">Nonaktif</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Kolom Kanan -->
      <div class="space-y-6">
        <!-- Gambar Produk -->
        <div>
          <h3 class="text-lg font-medium text-gray-800 mb-4">Gambar Produk</h3>
          
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
            <div id="imagePreview" class="mb-4 flex justify-center">
              <i class="fas fa-image text-gray-400 text-4xl"></i>
            </div>
            <p class="text-sm text-gray-600 mb-2">Seret dan lepas gambar di sini atau klik untuk mengunggah</p>
            <input
              type="file"
              id="product_image"
              name="product_image"
              accept="image/*"
              class="hidden"
            />
            <button 
              type="button" 
              id="uploadImageBtn" 
              class="bg-linkedin-blue hover:bg-linkedin-dark text-white px-4 py-2 rounded-lg font-medium transition duration-200"
            >
              <i class="fas fa-upload mr-2"></i>Unggah Gambar
            </button>
            <p class="text-xs text-gray-500 mt-2">Format yang didukung: JPG, PNG, GIF. Maksimal 5MB</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tombol Aksi -->
    <div class="flex justify-end space-x-3 pt-6 mt-6 border-t border-gray-200">
      <button 
        type="button" 
        class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition duration-200"
        onclick="window.location.href='/admin/products'"
      >
        Batal
      </button>
      <button 
        type="submit" 
        class="bg-linkedin-blue hover:bg-linkedin-dark text-white px-6 py-2 rounded-lg font-medium transition duration-200"
      >
        <i class="fas fa-save mr-2"></i>Simpan Produk
      </button>
    </div>
  </form>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Add product page loaded');
  
  // Elements
  const uploadArea = document.querySelector('.border-dashed');
  const uploadImageBtn = document.getElementById('uploadImageBtn');
  const productImage = document.getElementById('product_image');
  const imagePreview = document.getElementById('imagePreview');
  const addProductForm = document.getElementById('addProductForm');
  
  // Constants
  const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB in bytes
  const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
  
  // Initialize upload area
  function initializeUploadArea() {
    // Click event for upload button
    uploadImageBtn.addEventListener('click', function() {
      productImage.click();
    });
    
    // File input change event
    productImage.addEventListener('change', function(e) {
      handleFileSelection(e.target.files[0]);
    });
    
    // Drag and drop events
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      uploadArea.classList.add('border-linkedin-blue', 'bg-blue-50');
      uploadArea.classList.remove('border-gray-300');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      if (!uploadArea.contains(e.relatedTarget)) {
        uploadArea.classList.remove('border-linkedin-blue', 'bg-blue-50');
        uploadArea.classList.add('border-gray-300');
      }
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      uploadArea.classList.remove('border-linkedin-blue', 'bg-blue-50');
      uploadArea.classList.add('border-gray-300');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileSelection(files[0]);
      }
    });
    
    // Click on upload area to trigger file input
    uploadArea.addEventListener('click', function(e) {
      if (e.target !== uploadImageBtn && !e.target.closest('button')) {
        productImage.click();
      }
    });
  }
  
  // Handle file selection and validation
  function handleFileSelection(file) {
    if (!file) return;
    
    // Reset previous errors
    clearError();
    
    // Validate file
    const validation = validateFile(file);
    if (!validation.isValid) {
      showError(validation.message);
      return;
    }
    
    // Preview image
    previewImage(file);
    
    // Update UI
    updateUploadAreaState('success', 'Gambar berhasil diunggah!');
  }
  
  // Validate file
  function validateFile(file) {
    // Check file type
    if (!ALLOWED_TYPES.includes(file.type)) {
      return {
        isValid: false,
        message: 'Format file tidak didukung. Gunakan JPG, PNG, atau GIF.'
      };
    }
    
    // Check file size
    if (file.size > MAX_FILE_SIZE) {
      return {
        isValid: false,
        message: 'Ukuran file terlalu besar. Maksimal 5MB.'
      };
    }
    
    return { isValid: true, message: '' };
  }
  
  // Preview image
  function previewImage(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      imagePreview.innerHTML = `
        <div class="relative">
          <img src="${e.target.result}" class="max-h-48 rounded-lg object-cover mx-auto" alt="Preview">
          <button type="button" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600" onclick="removeImage()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
    };
    
    reader.onerror = function() {
      showError('Gagal membaca file gambar.');
    };
    
    reader.readAsDataURL(file);
  }
  
  // Remove image
  window.removeImage = function() {
    productImage.value = '';
    imagePreview.innerHTML = '<i class="fas fa-image text-gray-400 text-4xl"></i>';
    updateUploadAreaState('default', 'Seret dan lepas gambar di sini atau klik untuk mengunggah');
  };
  
  // Update upload area state
  function updateUploadAreaState(state, message) {
    const textElement = uploadArea.querySelector('p.text-sm');
    if (textElement) {
      textElement.textContent = message;
    }
    
    // Reset classes
    uploadArea.classList.remove('border-red-300', 'bg-red-50', 'border-green-300', 'bg-green-50');
    
    switch (state) {
      case 'error':
        uploadArea.classList.add('border-red-300', 'bg-red-50');
        break;
      case 'success':
        uploadArea.classList.add('border-green-300', 'bg-green-50');
        break;
      default:
        uploadArea.classList.add('border-gray-300');
        break;
    }
  }
  
  // Show error message
  function showError(message) {
    // Remove existing error
    clearError();
    
    // Create error element
    const errorElement = document.createElement('p');
    errorElement.className = 'text-red-500 text-sm mt-2 error-message';
    errorElement.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${message}`;
    
    uploadArea.appendChild(errorElement);
    updateUploadAreaState('error', message);
  }
  
  // Clear error message
  function clearError() {
    const existingError = uploadArea.querySelector('.error-message');
    if (existingError) {
      existingError.remove();
    }
  }
  
  // Enhanced form validation
  addProductForm.addEventListener('submit', function(e) {
    // Basic validation
    const productName = document.getElementById('product_name').value;
    const productPrice = document.getElementById('product_price').value;
    const productCategory = document.getElementById('product_category').value;
    const productImageFile = productImage.files[0];
    
    let hasError = false;
    
    // Reset all errors
    clearAllErrors();
    
    // Validate product name
    if (!productName.trim()) {
      showFieldError('product_name', 'Nama produk harus diisi');
      hasError = true;
    }
    
    // Validate price
    if (!productPrice || productPrice <= 0) {
      showFieldError('product_price', 'Harga produk harus lebih dari 0');
      hasError = true;
    }
    
    // Validate category
    if (!productCategory) {
      showFieldError('product_category', 'Kategori harus dipilih');
      hasError = true;
    }
    
    // Validate image (optional - remove if image is not required)
    if (!productImageFile) {
      showError('Gambar produk harus diunggah');
      hasError = true;
    } else {
      // Re-validate image on submit
      const validation = validateFile(productImageFile);
      if (!validation.isValid) {
        showError(validation.message);
        hasError = true;
      }
    }
    
    if (hasError) {
      e.preventDefault();
      return;
    }
    
    // Show loading state
    const submitBtn = addProductForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Menyimpan...';
    submitBtn.disabled = true;
    
    // Re-enable button if form doesn't submit (fallback)
    setTimeout(() => {
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }, 5000);
  });
  
  // Helper function to show field errors
  function showFieldError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const errorElement = document.createElement('p');
    errorElement.className = 'text-red-500 text-sm mt-1 error-message';
    errorElement.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i>${message}`;
    
    field.parentNode.appendChild(errorElement);
    field.classList.add('border-red-500');
  }
  
  // Helper function to clear all errors
  function clearAllErrors() {
    // Clear field errors
    document.querySelectorAll('.error-message').forEach(error => error.remove());
    document.querySelectorAll('input, select, textarea').forEach(field => {
      field.classList.remove('border-red-500');
    });
    
    // Clear upload area error
    clearError();
    updateUploadAreaState('default', 'Seret dan lepas gambar di sini atau klik untuk mengunggah');
  }
  
  // Real-time validation
  document.getElementById('product_name').addEventListener('blur', function() {
    if (!this.value.trim()) {
      showFieldError('product_name', 'Nama produk harus diisi');
    } else {
      clearFieldError('product_name');
    }
  });
  
  document.getElementById('product_price').addEventListener('blur', function() {
    if (!this.value || this.value <= 0) {
      showFieldError('product_price', 'Harga produk harus lebih dari 0');
    } else {
      clearFieldError('product_price');
    }
  });
  
  document.getElementById('product_category').addEventListener('change', function() {
    if (this.value) {
      clearFieldError('product_category');
    }
  });
  
  // Helper function to clear field error
  function clearFieldError(fieldId) {
    const field = document.getElementById(fieldId);
    const errorElement = field.parentNode.querySelector('.error-message');
    if (errorElement) {
      errorElement.remove();
    }
    field.classList.remove('border-red-500');
  }
  
  // Initialize everything
  initializeUploadArea();
});
</script>
{% endblock %}