{% extends "base.html" %} 
{% block title %}Order - LinkedCommerce{% endblock %} 
{% block content %}
<main class="bg-white rounded-lg shadow border border-gray-200 p-4 md:p-6" data-aos="fade-up">
  <div id="ordersContent" class="page-content">
    <h3 class="text-xl font-bold text-gray-800 mb-6 tracking-tight">Riwayat Pesanan</h3>
    <div class="space-y-6">
      {% for order in orders %}
      <div class="border border-gray-200 rounded-lg p-6 hover:shadow-sm transition-shadow bg-white relative">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h4 class="font-bold text-gray-900">Order #{{ order.id }}</h4>
            <p class="text-xs text-gray-500 font-medium">
              {{ order.created_at.strftime('%d %b %Y, %H:%M') if order.created_at else '-' }}
            </p>
          </div>
          <span class="bg-blue-50 text-linkedin-blue px-4 py-1.5 rounded-full text-[10px] font-bold border border-blue-100 uppercase tracking-widest">
            {{ order.status.value if order.status.value else (order.status if order.status else 'PENDING') }}
          </span>
        </div>

        <div class="space-y-5">
          {% set displayed_products = [] %}
          {% for po in order.product_orders %}
            {# Menghindari duplikasi produk yang sama dalam satu tampilan order #}
            {% if po.product_id not in displayed_products %}
              {% if displayed_products.append(po.product_id) %}{% endif %}
              <div class="flex items-start space-x-4">
                <div class="w-16 h-16 flex-shrink-0 bg-linkedin-background rounded-md border border-gray-100 overflow-hidden shadow-sm">
                  {% if po.product.image_url %}
                    <img src="{{ po.product.image_url }}" alt="Product" class="w-full h-full object-cover" />
                  {% else %}
                    <div class="w-full h-full flex items-center justify-center text-gray-300">
                      <i class="fas fa-image text-xl"></i>
                    </div>
                  {% endif %}
                </div>
                
                <div class="flex-1 pt-1">
                  <h5 class="font-bold text-gray-800 text-sm leading-tight mb-1">{{ po.product.product_name }}</h5>
                  <p class="text-xs text-gray-500">
                    {# Memperbaiki 'None' dengan default 1 #}
                    <span class="font-semibold text-gray-700">Qty: {{ po.quantity if po.quantity else 1 }}</span>
                    <span class="mx-2 text-gray-300">|</span>
                    <span class="text-linkedin-blue font-bold">
                        Rp {{ "{:,.0f}".format(po.product.product_price | default(0) | float).replace(',', '.') }}
                    </span>
                  </p>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        <div class="mt-8 pt-5 border-t border-gray-100 flex flex-col md:flex-row justify-between items-end md:items-center gap-5">
          <div class="w-full md:w-auto">
            <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-1">Total Pembayaran</p>
            <p class="font-bold text-2xl text-linkedin-blue tracking-tight">
                Rp {{ "{:,.0f}".format(order.amount | default(0) | float).replace(',', '.') }}
            </p>
          </div>
          <div class="flex space-x-3 w-full md:w-auto">
            <a href="{{ url_for('order_detail', order_id=order.id) }}" class="flex-1 md:flex-none border-2 border-linkedin-blue text-linkedin-blue px-7 py-2 rounded-full text-sm font-bold hover:bg-blue-50 transition-all duration-200">
              Detail
            </a>
           {% if order.product_orders and order.product_orders|length > 0 %}
    <a href="{{ url_for('form_order_user', product_id=order.product_orders[0].product_id) }}" 
       class="flex-1 md:flex-none bg-linkedin-blue text-white px-7 py-2 rounded-full text-sm font-bold hover:bg-linkedin-dark transition-all duration-200 shadow-md text-center">
       Beli Lagi
    </a>
{% endif %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center py-24 bg-linkedin-background rounded-xl border-2 border-dashed border-gray-200">
        <div class="bg-white w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
            <i class="fas fa-box-open text-gray-200 text-3xl"></i>
        </div>
        <p class="text-gray-500 font-bold text-lg">Belum ada pesanan</p>
        <p class="text-gray-400 text-sm mt-1">Produk yang Anda beli akan muncul di sini.</p>
        <a href="{{ url_for('produk_user') }}" class="mt-6 inline-block bg-linkedin-blue text-white px-8 py-2 rounded-full font-bold text-sm">Jelajahi Produk</a>
      </div>
      {% endfor %}
    </div>
  </div>
</main>
{% endblock %}