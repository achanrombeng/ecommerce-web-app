{% extends "base-admin.html" %} {% block title %}Kelola Produk -
LinkedCommerce{% endblock %} {% block page_title %}Kelola Produk{% endblock %}
{% block page_icon %}cube{% endblock %} {% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Produk</span>
  </div>
</li>
{% endblock %} {% block content %}
<link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.13.6/css/dataTables.tailwindcss.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
/>
<link
  href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
  rel="stylesheet"
/>

<style>
  /* 1. Paksa Container Utama */
  .overflow-x-auto.w-full {
    display: block !important;
    width: 100% !important;
    overflow-x: auto !important;
  }

  /* 2. Paksa Tabel dan Wrapper Datatables */
  #productsTable,
  .dataTables_wrapper,
  .dataTables_scrollHeadInner,
  .dataTables_scrollBody,
  table.dataTable {
    width: 100% !important;
    min-width: 100% !important;
    margin: 0 !important;
  }

  /* 3. Pengaturan Rata Kiri Semua Kolom */
  #productsTable th, 
  #productsTable td {
    text-align: left !important; /* Rata kiri semua */
    vertical-align: middle !important;
    padding: 12px 16px !important; /* Jarak antar kolom lebih lega */
  }

  #productsTable td {
    white-space: nowrap;
  }

  /* Izinkan Nama Produk untuk Wrap jika layar sempit */
  #productsTable td:nth-child(2) {
    white-space: normal !important;
    min-width: 250px;
  }

  .dataTables_wrapper .grid {
    margin: 0 !important;
    width: 100% !important;
  }
</style>

<div class="space-y-6">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4" data-aos="fade-up">
    <div>
      <h2 class="text-xl font-semibold text-gray-800">Daftar Produk</h2>
      <p class="text-sm text-gray-600 mt-1">Kelola semua produk di toko online Anda</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6" data-aos="fade-up" data-aos-delay="100">
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-linkedin-blue">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Total Produk</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalProducts">{{ total_products }}</h3>
        </div>
        <div class="bg-linkedin-background p-3 rounded-full">
          <i class="fas fa-cube text-linkedin-blue text-xl"></i>
        </div>
      </div>
    </div>
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Produk Aktif</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="activeProducts">{{ active }}</h3>
        </div>
        <div class="bg-green-50 p-3 rounded-full">
          <i class="fas fa-check-circle text-green-500 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-yellow-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Stok Menipis</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="lowStock">{{ low }}</h3>
        </div>
        <div class="bg-yellow-50 p-3 rounded-full">
          <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
        </div>
      </div>
    </div>
    <div class="stats-card bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-medium text-gray-600">Habis Stok</p>
          <h3 class="text-2xl font-bold text-gray-800 mt-1" id="outOfStock">{{ out }}</h3>
        </div>
        <div class="bg-red-50 p-3 rounded-full">
          <i class="fas fa-times-circle text-red-500 text-xl"></i>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow" data-aos="fade-up" data-aos-delay="200">
    <div class="p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
          <i class="fas fa-list"></i> Daftar Produk
        </h2>
        <div class="gap-4 flex">
          <a class="bg-linkedin-blue hover:bg-linkedin-dark text-white px-4 py-2 rounded-lg font-medium transition duration-200" href="{{ url_for('admin_add_product') }}">
            <i class="fas fa-plus mr-2"></i>Tambah Produk
          </a>
          <button type="button" onclick="reloadTable()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition">
            <i class="fa-solid fa-rotate-right mr-1"></i>Refresh
          </button>
        </div>
      </div>

      <div class="overflow-x-auto w-full">
        <table id="productsTable" class="w-full" style="width: 100% !important">
          <thead class="bg-gray-100 border-b border-gray-300">
            <tr class="bg-gray-50">
              <th class="px-4 py-3"></th>
              <th class="px-4 py-3">
                <input type="text" id="filterName" placeholder="Filter Nama" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue"/>
              </th>
              <th class="px-4 py-3">
                <select id="filterCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Kategori</option>
                  <option value="smartphone">Smartphone</option>
                  <option value="laptop">Laptop</option>
                  <option value="aksesoris">Aksesoris</option>
                  <option value="tablet">Tablet</option>
                </select>
              </th>
              <th class="px-4 py-3">
                <input type="number" id="filterPrice" placeholder="Max Harga" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue"/>
              </th>
              <th class="px-4 py-3">
                <input type="number" id="filterStock" placeholder="Max Stok" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue"/>
              </th>
              <th class="px-4 py-3">
                <select id="filterStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-linkedin-blue">
                  <option value="">Semua Status</option>
                  <option value="aktif">Aktif</option>
                  <option value="nonaktif">Non-aktif</option>
                </select>
              </th>
              <th class="px-4 py-3"></th>
            </tr>
            <tr>
              <th class="text-sm font-semibold text-gray-700">No</th>
              <th class="text-sm font-semibold text-gray-700">Nama Produk</th>
              <th class="text-sm font-semibold text-gray-700">Kategori</th>
              <th class="text-sm font-semibold text-gray-700">Harga</th>
              <th class="text-sm font-semibold text-gray-700">Stock</th>
              <th class="text-sm font-semibold text-gray-700">Status</th>
              <th class="text-sm font-semibold text-gray-700">Aksi</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.tailwindcss.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let productTable;
  const canUpdate = "{{ can_update|tojson }}";
  const canDelete = "{{ can_delete|tojson }}";

  $(function() {
      productTable = $('#productsTable').DataTable({
          processing: true,
          serverSide: false,
          autoWidth: false,
          searching: false,
          ordering: true,
          order: [[0, 'asc']],
          pageLength: 10,
          dom: 'rtip',
          ajax: {
              url: "{{ url_for('admin_products') }}",
              type: "POST",
              data: function(d) {
                  return {
                      name: $('#filterName').val(),
                      category: $('#filterCategory').val(),
                      maxPrice: $('#filterPrice').val(),
                      status: $('#filterStatus').val()
                  };
              }
          },
          columns: [
              { data: null, className: "text-left w-12", render: (data, type, row, meta) => meta.row + 1 },
              {
                  data: "product_name",
                  className: "text-left",
                  render: function (data, type, row) {
                      const placeholder = `https://ui-avatars.com/api/?name=${encodeURIComponent(data)}`;
                      return `
                      <div class="flex items-center justify-start min-w-[250px]">
                          <img class="h-10 w-10 rounded shadow-sm flex-shrink-0" src="${row.product_image || placeholder}">
                          <div class="ml-3 text-left"> 
                              <div class="text-sm font-bold text-gray-900 leading-tight">${data}</div>
                              <div class="text-xs text-gray-500">ID: #${row.product_id}</div>
                          </div>
                      </div>`;
                  }
              },
              { data: "product_category", className: "text-left" },
              { 
                  data: "product_price", 
                  className: "text-left", 
                  render: (data) => `<b class="whitespace-nowrap">Rp ${data}</b>` 
              },
              { data: "product_stock", className: "text-left" },
              {
                  data: "product_status",
                  className: "text-left",
                  render: function (data) {
                      const cls = data === 'Available' || data === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                      return `<span class="px-3 py-1 rounded-full text-xs font-medium ${cls}">${data}</span>`;
                  },
              },
              {
                  data: null,
                  orderable: false,
                  className: "text-left",
                  render: function (data, type, row) {
                      let html = '<div class="flex justify-start gap-2">';
                      if (canUpdate == true || canUpdate == "true") {
                          html += `
                          <button onclick="editProduct(${row.product_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Edit">
                              <i class="fas fa-edit"></i>
                          </button>`;
                      }
                      if (canDelete == true || canDelete == "true") {
                          html += `
                          <button onclick="deleteProduct(${row.product_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Hapus">
                              <i class="fas fa-trash"></i>
                          </button>`;
                      }
                      html += '</div>';
                      return html;
                  },
              },
          ],
          "drawCallback": function( settings ) {
               this.api().columns.adjust();
          }
      });

      $('#filterName, #filterPrice, #filterCategory, #filterStatus').on('change keyup', function() {
          productTable.ajax.reload();
      });
  });

  function reloadTable() {
      if (productTable) {
          productTable.ajax.reload(null, false); // false agar tetap di halaman pagination yang sama
      }
  }

  function editProduct(id) {
      window.location.href = "{{ url_for('admin_edit_product', product_id=0) }}".replace('0', id);
  }

  function deleteProduct(id) {
      Swal.fire({
          title: 'Apakah Anda yakin?',
          text: "Produk yang dihapus tidak bisa dikembalikan!",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Ya, hapus!',
          cancelButtonText: 'Batal'
      }).then((result) => {
          if (result.isConfirmed) {
              fetch("{{ url_for('admin_delete_product', product_id=0) }}".replace('0', id), {
                  method: 'DELETE',
              })
              .then(response => response.json())
              .then(data => {
                  if(data.success) {
                      Swal.fire('Terhapus!', 'Produk telah dihapus.', 'success');
                      productTable.ajax.reload();
                  } else {
                      Swal.fire('Gagal!', data.message, 'error');
                  }
              });
          }
      })
  }
</script>

<style>
  #productsTable_wrapper .dataTables_paginate .paginate_button.current {
    background: #0a66c2 !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
  }
</style>
{% endblock %}