{% extends "base-admin.html" %} {% block title %}Tambah User - LinkedCommerce{%
endblock %} {% block page_title %}Tambah User{% endblock %} {% block page_icon
%}user-plus{% endblock %} {% block breadcrumb %}
<li>
  <div class="flex items-center">
    <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
    <span class="text-sm font-medium text-gray-500">Tambah User</span>
  </div>
</li>
{% endblock %} {% block content %}
<div class="space-y-6">
  <form
    id="addUserForm"
    action="{{ url_for('admin_add_user')}}"
    method="POST"
    enctype="multipart/form-data"
  >
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left Column - Profile Picture & Info -->
      <div class="lg:col-span-1" data-aos="fade-right">
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-6">Foto Profil</h3>

          <div class="flex flex-col items-center space-y-4">
            <div class="relative">
              <img
                id="profilePreview"
                src="https://ui-avatars.com/api/?name=New+User&background=0077b5&color=fff&size=200"
                alt="Profile"
                class="w-40 h-40 rounded-full object-cover border-4 border-linkedin-background shadow-lg"
              />
            </div>
          </div>

          <!-- Account Info -->
          <div class="mt-6 pt-6 border-t border-gray-200 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Role:</span>
              <select
                name="role"
                id="roleSelect"
                required
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-linkedin-blue text-white focus:outline-none focus:ring-2 focus:ring-linkedin-blue"
              >
                <option value="">Pilih Role</option>
                <option value="USER">User</option>
                <option value="ADMIN">Admin</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Forms -->
      <div class="lg:col-span-2 space-y-6" data-aos="fade-left">
        <!-- Personal Information -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-6">
            Informasi Pribadi
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nama Depan <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                name="first_name"
                id="firstName"
                required
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
                placeholder="Masukkan nama depan"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nama Belakang
              </label>
              <input
                type="text"
                name="last_name"
                id="lastName"
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
                placeholder="Masukkan nama belakang"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Email <span class="text-red-500">*</span>
              </label>
              <input
                type="email"
                name="email"
                id="email"
                required
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
                placeholder="example@email.com"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nomor Telepon
              </label>
              <input
                type="tel"
                name="phone_number"
                id="phoneNumber"
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
                placeholder="+62 812-3456-7890"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Jenis Kelamin
              </label>
              <select
                name="gender"
                id="gender"
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
              >
                <option value="">Pilih jenis kelamin</option>
                <option value="MALE">Male</option>
                <option value="FEMALE">Female</option>
                <option value="OTHER">Other</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Tanggal Lahir
              </label>
              <input
                type="date"
                name="birth_date"
                id="birthDate"
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Alamat
              </label>
              <textarea
                name="address"
                id="address"
                rows="3"
                class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition resize-none"
                placeholder="Masukkan alamat lengkap"
              ></textarea>
            </div>
          </div>
        </div>

        <!-- Password Section -->
        <div class="bg-white rounded-lg shadow-sm p-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">
            Password Akun
          </h3>
          <p class="text-sm text-gray-600 mb-6">
            Masukkan password untuk akun baru
          </p>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Password <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  name="password"
                  id="password"
                  required
                  class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition pr-10"
                  placeholder="Masukkan password"
                />
                <button
                  type="button"
                  onclick="togglePassword('password', this)"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-linkedin-blue transition"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-1">
                <i class="fas fa-info-circle mr-1"></i>Minimal 8 karakter
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Konfirmasi Password <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="password"
                  name="confirm_password"
                  id="confirmPassword"
                  required
                  class="w-full px-4 py-2.5 bg-linkedin-background border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-linkedin-blue focus:border-transparent transition pr-10"
                  placeholder="Konfirmasi password"
                />
                <button
                  type="button"
                  onclick="togglePassword('confirmPassword', this)"
                  class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-linkedin-blue transition"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-3">
          <a
            href="{{ url_for('admin_users') }}"
            class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium"
          >
            <i class="fas fa-times mr-2"></i>Batal
          </a>
          <button
            type="submit"
            id="submitBtn"
            class="px-6 py-2.5 bg-linkedin-blue text-white rounded-lg hover:bg-linkedin-dark transition font-medium shadow-sm"
          >
            <i class="fas fa-save mr-2"></i>Tambah User
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Toggle password visibility
  function togglePassword(fieldId, button) {
    const field = document.getElementById(fieldId);
    const icon = button.querySelector("i");

    if (field.type === "password") {
      field.type = "text";
      icon.classList.remove("fa-eye");
      icon.classList.add("fa-eye-slash");
    } else {
      field.type = "password";
      icon.classList.remove("fa-eye-slash");
      icon.classList.add("fa-eye");
    }
  }

  // Form submission handler
  document.getElementById("addUserForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    // Collect form data
    const formData = {
      first_name: document.getElementById("firstName").value.trim(),
      last_name: document.getElementById("lastName").value.trim(),
      email: document.getElementById("email").value.trim(),
      phone_number: document.getElementById("phoneNumber").value.trim(),
      gender: document.getElementById("gender").value,
      birth_date: document.getElementById("birthDate").value,
      address: document.getElementById("address").value.trim(),
      role: document.getElementById("roleSelect").value,
      password: document.getElementById("password").value,
      confirm_password: document.getElementById("confirmPassword").value,
    };

    // Validations
    if (!formData.first_name) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Nama depan wajib diisi!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    if (!formData.email) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Email wajib diisi!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(formData.email)) {
      Swal.fire({
        icon: "error",
        title: "Email Tidak Valid",
        text: "Format email tidak sesuai!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    if (!formData.role) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Role harus dipilih!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    if (!formData.password) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Password wajib diisi!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    if (formData.password.length < 8) {
      Swal.fire({
        icon: "error",
        title: "Password Terlalu Pendek",
        text: "Password minimal 8 karakter!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    if (formData.password !== formData.confirm_password) {
      Swal.fire({
        icon: "error",
        title: "Password Tidak Cocok",
        text: "Password dan konfirmasi password tidak sama!",
        confirmButtonColor: "#0a66c2",
      });
      return;
    }

    // Validate birth date if provided
    if (formData.birth_date) {
      const birthDate = new Date(formData.birth_date);
      const today = new Date();
      if (birthDate > today) {
        Swal.fire({
          icon: "error",
          title: "Tanggal Tidak Valid",
          text: "Tanggal lahir tidak boleh lebih dari hari ini!",
          confirmButtonColor: "#0a66c2",
        });
        return;
      }
    }

    // Confirmation
    const confirmResult = await Swal.fire({
      title: "Tambah User Baru?",
      text: "Apakah Anda yakin ingin menambahkan user ini?",
      icon: "question",
      showCancelButton: true,
      confirmButtonColor: "#0a66c2",
      cancelButtonColor: "#d33",
      confirmButtonText: "Ya, Tambahkan!",
      cancelButtonText: "Batal",
    });

    if (!confirmResult.isConfirmed) {
      return;
    }

    // Show loading
    Swal.fire({
      title: "Menyimpan...",
      text: "Sedang menambahkan user baru",
      allowOutsideClick: false,
      didOpen: () => {
        Swal.showLoading();
      },
    });

    try {
      // Prepare FormData for file upload
      const submitFormData = new FormData(this);

      const response = await fetch(this.action, {
        method: "POST",
        body: submitFormData,
      });

      const data = await response.json();

      Swal.close();

      if (data.success) {
        await Swal.fire({
          icon: "success",
          title: "Berhasil!",
          text: data.message || "User berhasil ditambahkan",
          confirmButtonColor: "#0a66c2",
        });

        window.location.href = "{{ url_for('admin_users') }}";
      } else {
        Swal.fire({
          icon: "error",
          title: "Gagal!",
          text: data.message || "Terjadi kesalahan saat menambahkan user",
          confirmButtonColor: "#0a66c2",
        });
      }
    } catch (error) {
      Swal.close();
      Swal.fire({
        icon: "error",
        title: "Kesalahan Jaringan",
        text: "Terjadi kesalahan koneksi. Silakan coba lagi.",
        confirmButtonColor: "#0a66c2",
      });
      console.error("Error:", error);
    }
  });
</script>
{% endblock %}